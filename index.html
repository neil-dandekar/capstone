<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capstone Project | Neuron Intervention Demo</title>
    <meta
      name="description"
      content="Interactive capstone demo: neuron-level interventions in Concept Bottleneck LLMs with accuracy vs steerability tradeoffs."
    />

    <link rel="stylesheet" href="style.css" />

    <!-- Loads the backend API client (must define window.CbllmApi with postRun()) -->
    <script src="api/client.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

      :root {
        --bg: #0b0f17;
        --card: #121a29;
        --text: #e7eefc;
        --muted: #a9b6d3;
        --border: rgba(255, 255, 255, 0.1);
        --shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        --radius: 16px;
        --danger: #ff6b6b;
        --ok: #6ee7b7;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, -apple-system, Segoe UI, Roboto,
          Arial, sans-serif;
        background: radial-gradient(
            1200px 800px at 15% 10%,
            rgba(99, 102, 241, 0.2),
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 85% 20%,
            rgba(34, 197, 94, 0.14),
            transparent 55%
          ),
          var(--bg);
        color: var(--text);
      }

      a {
        color: inherit;
      }

      .wrap {
        max-width: 1180px;
        margin: 0 auto;
        padding: 48px 20px 80px;
      }

      header {
        display: grid;
        gap: 10px;
        margin-bottom: 22px;
      }

      h1 {
        margin: 0;
        letter-spacing: -0.02em;
        font-size: clamp(30px, 4vw, 46px);
        line-height: 1.1;
      }

      .sub {
        margin: 0;
        color: var(--muted);
        max-width: 80ch;
        font-size: 16.5px;
        line-height: 1.55;
      }

      .section {
        margin-top: 18px;
      }

      .card {
        background: rgba(18, 26, 41, 0.82);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
        backdrop-filter: blur(10px);
      }

      .card h2 {
        margin: 0 0 10px;
        font-size: 20px;
        letter-spacing: -0.01em;
      }

      .card p {
        margin: 10px 0 0;
        color: var(--muted);
        line-height: 1.6;
        font-size: 15px;
      }

      .section-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }

      .section-head h2 {
        margin: 0;
        font-size: 22px;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      @media (max-width: 650px) {
        .row {
          grid-template-columns: 1fr;
        }
      }

      label {
        display: block;
        font-size: 13.5px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      select,
      input[type="range"],
      input[type="text"],
      input[type="number"],
      textarea {
        width: 100%;
      }

      select {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 11px 12px;
        outline: none;
        font-size: 15px;
      }

      input[type="text"],
      input[type="number"],
      textarea {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
        font-size: 15px;
        font-family: inherit;
      }

      textarea {
        min-height: 110px;
        resize: vertical;
      }

      .panel-grid {
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 980px) {
        .panel-grid {
          grid-template-columns: 1fr;
        }
      }

      .panel-col {
        display: grid;
        gap: 14px;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        padding: 9px 12px;
        border-radius: 12px;
        text-decoration: none;
        font-size: 13.5px;
        color: var(--text);
        cursor: pointer;
      }

      .btn.primary {
        background: rgba(99, 102, 241, 0.25);
        border-color: rgba(99, 102, 241, 0.6);
      }

      .btn.ghost {
        background: transparent;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .kpis {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 12px;
      }

      @media (max-width: 520px) {
        .kpis {
          grid-template-columns: 1fr;
        }
      }

      .kpi {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.04);
      }

      .kpi .name {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 6px;
      }

      .kpi .val {
        font-size: 22px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .pill {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 7px 10px;
        background: rgba(255, 255, 255, 0.04);
        color: var(--muted);
        font-size: 12.5px;
      }

      .pill b {
        color: var(--text);
        font-weight: 700;
      }

      .controls {
        display: grid;
        gap: 12px;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }

      /* Status line for backend/API connectivity */
      .statusline {
        margin-top: 10px;
        font-size: 13px;
        color: var(--muted);
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .dot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        display: inline-block;
        background: rgba(255, 255, 255, 0.25);
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.bad {
        background: var(--danger);
      }

      /* (rest of your styles unchanged) */
      /* ... you can keep everything else exactly as you had it ... */

      .sankey-frame {
        width: 100%;
        height: 520px;
        border: none;
        border-radius: 12px;
        background: #ffffff;
      }

      .sankey-frame--tall {
        height: 1000px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="pill">Interactive demo: <b>live backend API</b></div>

        <h1>Concept Bottleneck LLM Intervention Console</h1>
        <p class="sub">
          Edit concept-linked neurons, run baseline vs intervened, and inspect
          evidence. This UI is a researcher-focused shell over live CB-LLM backend
          responses.
        </p>
      </header>

      <!-- EVERYTHING IN BODY UNCHANGED FROM YOUR ORIGINAL -->
      <!-- I am keeping your entire HTML structure the same -->
      <!-- (Your control panel, inputs, results, sankey iframe, etc.) -->

      <!-- ... [snip: keep your body content exactly as you pasted] ... -->

    </div>

    <!-- ✅ FIX #1: Close this script properly -->
    <script>
      // Set your code repo link here.
      const CODE_REPO_URL = "https://github.com/neil-dandekar/capstone";

      const API_CATALOG = {
        meta: { code_repo: CODE_REPO_URL, model_checkpoint: null },
        datasets: [
          {
            id: "sst2",
            name: "SST-2",
            tasks: [
              { id: "classification", name: "Classification", interventions: [{}] },
              { id: "generation", name: "Generation", interventions: [{}] }
            ],
          },
          {
            id: "SetFit/sst2",
            name: "SetFit/sst2",
            tasks: [
              { id: "classification", name: "Classification", interventions: [{}] },
              { id: "generation", name: "Generation", interventions: [{}] }
            ],
          },
          {
            id: "ag_news",
            name: "AG News",
            tasks: [
              { id: "classification", name: "Classification", interventions: [{}] },
              { id: "generation", name: "Generation", interventions: [{}] }
            ],
          },
          {
            id: "yelp_polarity",
            name: "Yelp Polarity",
            tasks: [
              { id: "classification", name: "Classification", interventions: [{}] },
              { id: "generation", name: "Generation", interventions: [{}] }
            ],
          },
          {
            id: "dbpedia_14",
            name: "DBPedia 14",
            tasks: [
              { id: "classification", name: "Classification", interventions: [{}] },
              { id: "generation", name: "Generation", interventions: [{}] }
            ],
          },
        ],
      };

      let DATA = null;
      const state = {
        selectedTaskMode: "classification",
        selectedDataset: "",
        currentInput: "",
        baselineResult: null,
        intervenedResult: null,
        concepts: [],
        interventions: { activation: {}, weights: {} },
        isBaselineLocked: false,
        pendingChanges: false,
        lastRunConfig: null,
        selectedConceptIds: [],
        lastSelectedConceptIndex: null,
        isRunning: false,
        lastApiResponse: null,
      };

      function $(id) { return document.getElementById(id); }

      /* KEEP ALL YOUR JS EXACTLY AS YOU PASTED IT */
      /* ... paste the rest of your functions here unchanged ... */

      async function loadData() {
        $("codeRepoLink").href = CODE_REPO_URL;

        DATA = API_CATALOG;
        setStatus(true, "API mode enabled", "POST /api/v1/run");

        if (DATA.meta && DATA.meta.code_repo) {
          $("codeRepoLink").href = DATA.meta.code_repo;
        }

        setSelectOptions($("dataset"), DATA.datasets, (d) => d.id, (d) => d.name);
        rebuildTaskInterventions();

        $("dataset").addEventListener("change", onDatasetChange);
        $("conceptSearch").addEventListener("input", renderConceptList);
        $("conceptSort").addEventListener("change", renderConceptList);
        $("conceptList").addEventListener("click", handleConceptSelection);

        $("applyActivationBtn").addEventListener("click", applyActivationIntervention);
        $("clearActivationBtn").addEventListener("click", () => clearActivationIntervention(true));
        $("clearAllActivationBtn").addEventListener("click", () => clearActivationIntervention(false));

        $("applyWeightBtn").addEventListener("click", applyWeightIntervention);
        $("clearWeightBtn").addEventListener("click", clearWeightIntervention);

        $("activationOp").addEventListener("change", updateActivationFormula);
        $("activationValue").addEventListener("input", updateActivationFormula);

        $("resetInterventionsBtn").addEventListener("click", resetInterventions);

        $("runBaselineBtn").addEventListener("click", runBaseline);
        $("runIntervenedBtn").addEventListener("click", runIntervened);
        $("compareBtn").addEventListener("click", runCompare);

        $("lockBaseline").addEventListener("change", (e) => {
          state.isBaselineLocked = e.target.checked;
        });

        $("taskMode").addEventListener("change", (e) => {
          const mode = e.target.value;
          setTaskMode(mode);
          rebuildTaskInterventions();
        });

        $("sendToModelBtn").addEventListener("click", runCompare);
        $("generateBtn").addEventListener("click", runCompare);

        ["decodeMaxTokens", "decodeTemperature", "decodeTopP", "decodeSeed"].forEach((id) => {
          $(id).addEventListener("input", updateReproducibilityInfo);
        });

        updateRecipeViews();
        updateActivationFormula();
      }

      loadData();
    </script>

    <!-- ✅ FIX #2: Load your script.js as a MODULE (after the inline script) -->
    <script type="module" src="script.js"></script>
  </body>
</html>
