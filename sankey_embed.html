<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Concept â†’ Class Sankey</title>
        <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
        <style>
            html,
            body {
                margin: 0;
                height: 100%;
                background: white;
            }

            #sankey {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="sankey" aria-label="Concept to class flow diagram"></div>
        <script>
            const conceptPalette = [
                "#4c78a8",
                "#f58518",
                "#54a24b",
                "#e45756",
                "#72b7b2",
                "#b279a2",
                "#ff9da6",
                "#9d755d",
                "#bab0ab",
                "#5f6b6d",
            ];

            const classPalette = [
                "#1f2937",
                "#2563eb",
                "#16a34a",
                "#d97706",
                "#9333ea",
            ];

            function mulberry32(seed) {
                let t = seed;
                return function () {
                    t += 0x6d2b79f5;
                    let r = Math.imul(t ^ (t >>> 15), 1 | t);
                    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
                    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
                };
            }

            function hexToRgba(hex, alpha) {
                const value = hex.replace("#", "");
                const full =
                    value.length === 3
                        ? value
                              .split("")
                              .map((ch) => ch + ch)
                              .join("")
                        : value;
                const r = parseInt(full.substring(0, 2), 16);
                const g = parseInt(full.substring(2, 4), 16);
                const b = parseInt(full.substring(4, 6), 16);
                return `rgba(${r},${g},${b},${alpha})`;
            }

            function buildSyntheticData({
                numConcepts = 32,
                numClasses = 4,
                seed = 7,
            } = {}) {
                const rng = mulberry32(seed);
                const concepts = Array.from(
                    { length: numConcepts },
                    (_, i) => `Concept ${i + 1}`,
                );
                const classes = Array.from(
                    { length: numClasses },
                    (_, i) => `Class ${i + 1}`,
                );

                const sources = [];
                const targets = [];
                const values = [];
                const linkColors = [];

                concepts.forEach((_, conceptIndex) => {
                    const weights = Array.from({ length: numClasses }, () =>
                        rng(),
                    );
                    const peakIndex = Math.floor(rng() * numClasses);
                    weights[peakIndex] *= 1.5 + rng() * 1.5;
                    const total = weights.reduce((acc, v) => acc + v, 0) || 1;
                    const scale = 20 + rng() * 60;

                    weights.forEach((weight, classIndex) => {
                        const flow = (scale * weight) / total;
                        if (flow <= 0.01) return;
                        sources.push(conceptIndex);
                        targets.push(numConcepts + classIndex);
                        values.push(Number(flow.toFixed(2)));
                        const baseColor =
                            conceptPalette[
                                conceptIndex % conceptPalette.length
                            ];
                        linkColors.push(hexToRgba(baseColor, 0.25));
                    });
                });

                const nodeColors = [
                    ...concepts.map(
                        (_, i) => conceptPalette[i % conceptPalette.length],
                    ),
                    ...classes.map(
                        (_, i) => classPalette[i % classPalette.length],
                    ),
                ];

                return {
                    labels: [...concepts, ...classes],
                    sources,
                    targets,
                    values,
                    nodeColors,
                    linkColors,
                };
            }

            const data = buildSyntheticData({
                numConcepts: 32,
                numClasses: 4,
                seed: 4,
            });

            Plotly.newPlot(
                "sankey",
                [
                    {
                        type: "sankey",
                        arrangement: "snap",
                        node: {
                            pad: 18,
                            thickness: 16,
                            line: { color: "black", width: 0.5 },
                            label: data.labels,
                            color: data.nodeColors,
                        },
                        link: {
                            source: data.sources,
                            target: data.targets,
                            value: data.values,
                            color: data.linkColors,
                        },
                    },
                ],
                {
                    margin: { l: 16, r: 16, t: 16, b: 16 },
                    paper_bgcolor: "white",
                    plot_bgcolor: "white",
                },
                { displayModeBar: false, responsive: true },
            );
        </script>
    </body>
</html>
